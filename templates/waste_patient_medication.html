{% extends "base.html" %}

{% block title %}Waste - {{ patient_med.patient_name }}{% endblock %}
{% block page_title %}Waste Patient Medication{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <span class="schedule-badge schedule-{{ patient_med.medication.schedule|lower }}">{{ patient_med.medication.schedule }}</span>
            {{ patient_med.medication.name }}
        </h3>
        <span class="quantity-display quantity-ok">{{ patient_med.quantity_remaining }} {{ patient_med.unit }} remaining</span>
    </div>
    <div class="card-body">
        <div class="patient-info-bar mb-3">
            <strong>Patient:</strong> {{ patient_med.patient_name }} 
            <span class="text-muted">| DOB: {{ patient_med.patient_dob.strftime('%m/%d/%Y') }}</span>
        </div>
        
        <div class="alert alert-warning mb-3">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <div>Wasting controlled substances requires a witness.</div>
        </div>
        
        <form method="POST">
            <div class="form-row">
                <div class="form-group">
                    <label class="required">Quantity to Waste</label>
                    <input type="number" name="quantity" class="form-control" required 
                           min="0.01" max="{{ patient_med.quantity_remaining }}" step="0.01" autofocus>
                    <small class="text-muted">{{ patient_med.unit }} (max: {{ patient_med.quantity_remaining }})</small>
                </div>
                <div class="form-group">
                    <label class="required">Witness</label>
                    <select name="witness_id" class="form-control" required>
                        <option value="">-- Select Witness --</option>
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.full_name }}{% if user.credentials %} ({{ user.credentials }}){% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="required">Reason for Waste</label>
                <select name="waste_reason" class="form-control" required id="waste_reason_select">
                    <option value="">-- Select Reason --</option>
                    <option value="Partial dose - remainder wasted">Partial dose - remainder wasted</option>
                    <option value="Patient refused">Patient refused</option>
                    <option value="Medication expired">Medication expired</option>
                    <option value="Contaminated">Contaminated</option>
                    <option value="Dropped/Spilled">Dropped/Spilled</option>
                    <option value="Order discontinued">Order discontinued</option>
                    <option value="Patient discharged">Patient discharged</option>
                    <option value="Other">Other (specify in notes)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Additional Notes</label>
                <textarea name="notes" class="form-control" rows="2" placeholder="Additional details if needed"></textarea>
            </div>
            
            <div class="form-actions">
                <a href="{{ url_for('patient_medication_detail', id=patient_med.id) }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-warning">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Record Waste
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.patient-info-bar {
    padding: 0.75rem 1rem;
    background: var(--bg-dark);
    border-radius: var(--radius);
}
</style>
{% endblock %}

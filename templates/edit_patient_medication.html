{% extends "base.html" %}

{% block title %}Edit Patient Medication{% endblock %}
{% block page_title %}Edit Patient Medication{% endblock %}

{% block header_actions %}
<a href="{{ url_for('patient_medication_detail', id=patient_med.id) }}" class="btn btn-secondary btn-sm">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
    </svg>
    Cancel
</a>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <span class="schedule-badge schedule-{{ patient_med.medication.schedule|lower }}">
                {{ patient_med.medication.schedule }}
            </span>
            {{ patient_med.medication.name }}
        </h3>
        <span class="text-muted">Patient: {{ patient_med.patient_name }}</span>
    </div>
    <div class="card-body">
        <div class="alert alert-warning mb-3">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <div>
                <strong>Administrator Only:</strong> Changes to lot numbers and expiration dates are logged in the audit trail.
            </div>
        </div>
        
        <form method="POST">
            <div class="form-section">
                <h3>Lot Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Lot Number</label>
                        <input type="text" name="lot_number" class="form-control" 
                               value="{{ patient_med.lot_number or '' }}" placeholder="Enter lot number">
                    </div>
                    <div class="form-group">
                        <label>Expiration Date</label>
                        <input type="date" name="expiration_date" class="form-control" 
                               value="{{ patient_med.expiration_date.strftime('%Y-%m-%d') if patient_med.expiration_date else '' }}">
                        {% if patient_med.expiration_date and patient_med.is_expired %}
                        <small class="text-danger">This item is expired!</small>
                        {% elif patient_med.expiration_date and patient_med.days_until_expiration <= 90 %}
                        <small class="text-warning">Expires in {{ patient_med.days_until_expiration }} days</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Other Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Storage Location</label>
                        <input type="text" name="storage_location" class="form-control" 
                               value="{{ patient_med.storage_location or '' }}" placeholder="e.g., Patient Fridge, Locked Cabinet">
                    </div>
                    <div class="form-group">
                        <label>Prescription Number</label>
                        <input type="text" name="prescription_number" class="form-control" 
                               value="{{ patient_med.prescription_number or '' }}">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Notes</h3>
                <div class="form-group">
                    <textarea name="notes" class="form-control" rows="3" 
                              placeholder="Additional notes">{{ patient_med.notes or '' }}</textarea>
                </div>
            </div>
            
            <div class="form-actions">
                <a href="{{ url_for('patient_medication_detail', id=patient_med.id) }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3 class="card-title">Patient & Medication Info (Read-Only)</h3>
    </div>
    <div class="card-body">
        <div class="detail-grid">
            <div class="detail-item">
                <label>Patient</label>
                <span>{{ patient_med.patient_name }}</span>
            </div>
            <div class="detail-item">
                <label>DOB</label>
                <span>{{ patient_med.patient_dob.strftime('%m/%d/%Y') }}</span>
            </div>
            <div class="detail-item">
                <label>Date Received</label>
                <span>{{ patient_med.preparation_date.strftime('%m/%d/%Y') }}</span>
            </div>
            <div class="detail-item">
                <label>Quantity Received</label>
                <span class="font-mono">{{ patient_med.quantity_prepared }} {{ patient_med.unit }}</span>
            </div>
            <div class="detail-item">
                <label>Quantity Remaining</label>
                <span class="font-mono">{{ patient_med.quantity_remaining }} {{ patient_med.unit }}</span>
            </div>
            <div class="detail-item">
                <label>Status</label>
                <span>{{ patient_med.status|title }}</span>
            </div>
        </div>
    </div>
</div>

<style>
.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing-lg);
}
.detail-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}
.detail-item label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
}
</style>
{% endblock %}

{% extends "base.html" %}

{% block title %}Form 222 #{{ form222.form_number }}{% endblock %}
{% block page_title %}Form 222 Details{% endblock %}

{% block header_actions %}
<a href="{{ url_for('form222_list') }}" class="btn btn-secondary btn-sm">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
    </svg>
    Back to List
</a>
{% if form222.status in ['pending', 'partial'] %}
<a href="{{ url_for('receive_form222', id=form222.id) }}" class="btn btn-primary btn-sm">Record Receipt</a>
{% endif %}
{% endblock %}

{% block content %}
<div class="card mb-3">
    <div class="card-header">
        <h3 class="card-title">
            <span class="font-mono">Form 222 #{{ form222.form_number }}</span>
        </h3>
        {% if form222.status == 'pending' %}
        <span class="status-badge status-warning">Pending</span>
        {% elif form222.status == 'partial' %}
        <span class="status-badge status-info">Partially Received</span>
        {% elif form222.status == 'complete' %}
        <span class="status-badge status-success">Complete</span>
        {% elif form222.status == 'void' %}
        <span class="status-badge status-danger">Void</span>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="detail-grid">
            <div class="detail-section">
                <h4>Order Information</h4>
                <dl class="detail-list">
                    <dt>Order Date</dt>
                    <dd>{{ form222.order_date.strftime('%m/%d/%Y') }}</dd>
                    
                    <dt>Received Date</dt>
                    <dd>{{ form222.received_date.strftime('%m/%d/%Y') if form222.received_date else 'Not yet received' }}</dd>
                    
                    <dt>Created By</dt>
                    <dd>{{ form222.creator.full_name if form222.creator else '-' }}</dd>
                </dl>
            </div>
            
            <div class="detail-section">
                <h4>Supplier</h4>
                <dl class="detail-list">
                    {% if form222.supplier %}
                    <dt>Name</dt>
                    <dd><a href="{{ url_for('supplier_detail', id=form222.supplier.id) }}">{{ form222.supplier.name }}</a></dd>
                    
                    <dt>DEA Number</dt>
                    <dd class="font-mono">{{ form222.supplier.dea_number }}</dd>
                    {% else %}
                    <dt>Supplier</dt>
                    <dd>Not specified</dd>
                    {% endif %}
                </dl>
            </div>
        </div>
        
        {% if form222.voided_reason %}
        <div class="alert alert-danger mt-3">
            <strong>Void Reason:</strong> {{ form222.voided_reason }}
        </div>
        {% endif %}
        
        {% if form222.notes %}
        <div class="mt-3">
            <strong>Notes:</strong>
            <p class="text-muted">{{ form222.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <h3 class="card-title">Line Items</h3>
    </div>
    <div class="card-body">
        {% if form222.line_items %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Line</th>
                        <th>Medication</th>
                        <th class="text-right">Ordered</th>
                        <th class="text-right">Received</th>
                        <th>Status</th>
                        <th>Inventory Link</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in form222.line_items|sort(attribute='line_number') %}
                    <tr>
                        <td class="font-mono">{{ item.line_number }}</td>
                        <td>
                            <span class="schedule-badge schedule-ii">II</span>
                            {{ item.medication.name }}
                            {% if item.medication.strength %}
                            <br><small class="text-muted">{{ item.medication.strength }}</small>
                            {% endif %}
                        </td>
                        <td class="text-right font-mono">{{ item.quantity_ordered }} {{ item.medication.unit or 'units' }}</td>
                        <td class="text-right font-mono">{{ item.quantity_received or 0 }} {{ item.medication.unit or 'units' }}</td>
                        <td>
                            {% if item.quantity_received >= item.quantity_ordered %}
                            <span class="status-badge status-success">Complete</span>
                            {% elif item.quantity_received > 0 %}
                            <span class="status-badge status-info">Partial</span>
                            {% else %}
                            <span class="status-badge status-warning">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.inventory_item %}
                            <a href="{{ url_for('inventory_detail', id=item.inventory_item.id) }}" class="btn btn-outline btn-sm">View Inventory</a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No line items recorded.</p>
        {% endif %}
    </div>
</div>

{% if form222.status not in ['complete', 'void'] and current_user.role == 'admin' %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Void Form</h3>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('void_form222', id=form222.id) }}" onsubmit="return confirm('Are you sure you want to void this Form 222?');">
            <div class="form-group">
                <label for="void_reason" class="form-label required">Reason for Voiding</label>
                <input type="text" name="void_reason" id="void_reason" class="form-control" required
                       placeholder="e.g., Order cancelled, Duplicate form, etc.">
            </div>
            <button type="submit" class="btn btn-danger">Void Form 222</button>
        </form>
    </div>
</div>
{% endif %}

<style>
.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-lg);
}
.detail-section h4 {
    margin-bottom: var(--spacing-md);
    color: var(--text-muted);
    font-size: 0.875rem;
    text-transform: uppercase;
}
.detail-list {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--spacing-sm) var(--spacing-md);
}
.detail-list dt {
    color: var(--text-muted);
    font-size: 0.875rem;
}
.detail-list dd {
    margin: 0;
}
</style>
{% endblock %}

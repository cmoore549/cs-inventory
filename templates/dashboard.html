{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block header_actions %}
<form method="POST" action="{{ url_for('restore_alerts') }}" style="display:inline;">
    <button type="submit" class="btn btn-secondary btn-sm" title="Restore any dismissed alerts">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
        </svg>
        Restore Alerts
    </button>
</form>
<a href="{{ url_for('receive_inventory') }}" class="btn btn-primary btn-sm">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    Receive Inventory
</a>
{% endblock %}

{% block content %}
<!-- Alert Banners -->
{% if biennial_due %}
<div class="alert alert-warning dismissable-alert">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    <div class="alert-content">
        <strong>Biennial Inventory {% if days_until_biennial <= 0 %}OVERDUE{% else %}Due Soon{% endif %}!</strong>
        {% if last_biennial %}
            Last completed: {{ last_biennial.inventory_date.strftime('%B %d, %Y') }}.
            {% if days_until_biennial > 0 %}Due in {{ days_until_biennial }} days.{% else %}Was due {{ -days_until_biennial }} days ago.{% endif %}
        {% else %}
            No biennial inventory on record. DEA requires inventory every 2 years.
        {% endif %}
        <a href="{{ url_for('new_biennial_inventory') }}" class="btn btn-warning btn-sm" style="margin-left: 1rem;">Start Biennial Inventory</a>
    </div>
    <form method="POST" action="{{ url_for('dismiss_alert') }}" class="alert-dismiss-form">
        <input type="hidden" name="alert_type" value="biennial_due">
        <input type="hidden" name="condition_value" value="{{ biennial_condition_value }}">
        <button type="submit" class="alert-dismiss-btn" title="Dismiss this alert">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </form>
</div>
{% endif %}

{% for reg in expiring_registrations %}
<div class="alert alert-danger dismissable-alert">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    <div class="alert-content">
        <strong>{{ reg.registration_type }} Registration Expiring!</strong>
        Registration #{{ reg.registration_number }} expires {{ reg.expiration_date.strftime('%B %d, %Y') }}.
        <a href="{{ url_for('manage_registrations') }}" class="btn btn-danger btn-sm" style="margin-left: 1rem;">View Registrations</a>
    </div>
    <form method="POST" action="{{ url_for('dismiss_alert') }}" class="alert-dismiss-form">
        <input type="hidden" name="alert_type" value="registration_expiring">
        <input type="hidden" name="alert_key" value="{{ reg.id }}">
        <input type="hidden" name="condition_value" value="{{ reg.expiration_date.isoformat() }}">
        <button type="submit" class="alert-dismiss-btn" title="Dismiss this alert">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </form>
</div>
{% endfor %}

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <svg viewBox="-1 -1 26 26" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19.5 12.5L12 20a4.82 4.82 0 0 1-7 0 4.82 4.82 0 0 1 0-7l7.5-7.5a4.82 4.82 0 0 1 7 0 4.82 4.82 0 0 1 0 7z"/>
                <line x1="8.5" y1="15.5" x2="15.5" y2="8.5"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ total_medications }}</div>
            <div class="stat-label">Active Medications</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon info">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ total_inventory_items }}</div>
            <div class="stat-label">Inventory Items</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon success">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ todays_transactions }}</div>
            <div class="stat-label">Today's Transactions</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon {% if todays_counts == 0 %}warning{% else %}success{% endif %}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ todays_counts }}</div>
            <div class="stat-label">Today's Counts</div>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Main Column - Left -->
    <div class="col-main">
        <!-- Pending Actions -->
        {% if pending_verifications or unresolved_discrepancies %}
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">‚ö†Ô∏è Pending Actions</h3>
            </div>
            <div class="card-body">
                {% if pending_verifications %}
                <div class="mb-3">
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem;">Counts In Progress</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Progress</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inv in pending_verifications %}
                                <tr>
                                    <td>
                                        {% if inv.inventory_type == 'daily' %}Daily
                                        {% elif inv.inventory_type == 'full' %}Full
                                        {% elif inv.inventory_type == 'schedule2' %}Schedule II
                                        {% else %}Spot Check{% endif %}
                                    </td>
                                    <td class="font-mono">{{ inv.inventory_date.strftime('%m/%d/%Y') }}</td>
                                    <td class="font-mono">{{ inv.counted_items }} / {{ inv.total_items }}</td>
                                    <td>
                                        <a href="{{ url_for('perform_physical_inventory', id=inv.id) }}" class="btn btn-primary btn-sm">Continue</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                
                {% if unresolved_discrepancies %}
                <div>
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--danger);">Recent Discrepancies</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Medication</th>
                                    <th>Expected</th>
                                    <th>Counted</th>
                                    <th>Diff</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in unresolved_discrepancies %}
                                {% set unit = item.inventory_item.unit_count or item.inventory_item.medication.unit or 'units' if item.inventory_item else 'units' %}
                                <tr>
                                    <td>{{ item.inventory_item.medication.name if item.inventory_item else item.drug_name }}</td>
                                    <td class="font-mono">{{ item.expected_quantity }} {{ unit }}</td>
                                    <td class="font-mono">{{ item.actual_quantity }} {{ unit }}</td>
                                    <td class="font-mono text-danger">{{ item.discrepancy }} {{ unit }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Activity</h3>
                <a href="{{ url_for('usage_report') }}" class="btn btn-secondary btn-sm">View All</a>
            </div>
            <div class="card-body">
                {% if recent_transactions %}
                <ul class="activity-list">
                    {% for tx in recent_transactions %}
                    <li class="activity-item">
                        <div class="activity-icon {{ tx.transaction_type }}">
                            {% if tx.transaction_type == 'dispense' %}
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            {% elif tx.transaction_type == 'waste' %}
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            {% elif tx.transaction_type == 'adjust' %}
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/></svg>
                            {% else %}
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>
                            {% endif %}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">
                                <span class="schedule-badge schedule-{{ tx.inventory_item.medication.schedule|lower }}">{{ tx.inventory_item.medication.schedule }}</span>
                                {{ tx.transaction_type|title }}: {{ tx.quantity }} {{ tx.inventory_item.unit_count or tx.inventory_item.medication.unit or 'units' }} {{ tx.inventory_item.medication.name }}{% if tx.inventory_item.medication.strength %} <span class="text-muted">({{ tx.inventory_item.medication.strength }})</span>{% endif %}
                            </div>
                            <div class="activity-meta">
                                {% if tx.patient_name %}Patient: {{ tx.patient_name }} ¬∑ {% endif %}
                                {{ tx.performer.full_name }} ¬∑ {{ tx.performed_at.strftime('%m/%d %H:%M') }}
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center">No recent activity</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Low Inventory - Under Recent Activity -->
        {% if low_inventory_meds %}
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h3 class="card-title">üìâ Low Inventory</h3>
                <a href="{{ url_for('reorder_list') }}" class="btn btn-secondary btn-sm">View All</a>
            </div>
            <div class="card-body">
                <ul class="activity-list" style="margin:0;">
                    {% for item in low_inventory_meds %}
                    <li class="activity-item">
                        <div class="activity-content">
                            <div class="activity-title">
                                <span class="schedule-badge schedule-{{ item.medication.schedule|lower }}">{{ item.medication.schedule }}</span>
                                {{ item.medication.name }}{% if item.medication.strength %} <span class="text-muted">({{ item.medication.strength }})</span>{% endif %}
                            </div>
                            <div class="activity-meta">
                                <span class="quantity-low font-mono font-bold">{{ item.total_quantity }}</span> {{ item.medication.unit or 'units' }} 
                                (threshold: {{ item.threshold }})
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Side Column - Right -->
    <div class="col-side">
        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="btn-group" style="flex-direction: column; gap: 0.5rem;">
                    <a href="{{ url_for('new_physical_inventory') }}" class="btn btn-primary btn-block">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        Perform Count
                    </a>
                    <a href="{{ url_for('dispense') }}" class="btn btn-success btn-block">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Dispense Medication
                    </a>
                    <a href="{{ url_for('waste') }}" class="btn btn-warning btn-block">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        Record Waste
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Expiring Inventory -->
        {% if expiring_items %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚è∞ Expiring Soon</h3>
                <a href="{{ url_for('expiration_management') }}" class="btn btn-secondary btn-sm">View All</a>
            </div>
            <div class="card-body">
                <ul class="activity-list" style="margin:0;">
                    {% for item in expiring_items %}
                    <li class="activity-item">
                        <div class="activity-content">
                            <div class="activity-title">
                                <span class="schedule-badge schedule-{{ item.medication.schedule|lower }}">{{ item.medication.schedule }}</span>
                                {{ item.medication.name }}{% if item.medication.strength %} <span class="text-muted">({{ item.medication.strength }})</span>{% endif %}
                            </div>
                            <div class="activity-meta">
                                {% set days_left = (item.expiration_date - now.date()).days %}
                                <span class="{% if days_left <= 30 %}text-danger font-bold{% elif days_left <= 60 %}text-warning{% endif %}">
                                    Expires: {{ item.expiration_date.strftime('%m/%d/%Y') }}
                                    {% if days_left <= 0 %}(EXPIRED){% elif days_left <= 30 %}({{ days_left }}d){% endif %}
                                </span>
                                ¬∑ Qty: {{ item.current_quantity }} {{ item.unit_count or item.medication.unit or 'units' }}
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
}

@media (max-width: 900px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}

.dismissable-alert {
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.alert-content {
    flex: 1;
}

.alert-dismiss-form {
    flex-shrink: 0;
}

.alert-dismiss-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    opacity: 0.5;
    padding: 0.25rem;
    border-radius: 4px;
    transition: opacity 0.2s, background 0.2s;
}

.alert-dismiss-btn:hover {
    opacity: 1;
    background: rgba(0,0,0,0.1);
}

.alert-warning .alert-dismiss-btn {
    color: #856404;
}

.alert-danger .alert-dismiss-btn {
    color: #721c24;
}
</style>
{% endblock %}

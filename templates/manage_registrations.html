{% extends "base.html" %}

{% block title %}Manage Registrations{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <h1>Registrations</h1>
        <p class="subtitle">DEA and NC-DCU registration tracking</p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('add_registration') }}" class="btn btn-primary">
            <i class="icon">+</i> Add Registration
        </a>
        <a href="{{ url_for('settings') }}" class="btn btn-secondary">
            <i class="icon">‚Üê</i> Back to Settings
        </a>
    </div>
</div>

<div class="registrations-container">
    {% set expiring_soon = registrations|selectattr('days_until_expiration')|selectattr('days_until_expiration', 'lt', 60)|list %}
    {% if expiring_soon %}
    <div class="alert alert-warning">
        <h4>‚ö†Ô∏è Registration Expiring Soon</h4>
        <p>{{ expiring_soon|length }} registration(s) will expire within 60 days. Renew promptly to maintain compliance.</p>
    </div>
    {% endif %}

    <div class="registrations-card">
        {% if registrations %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Registration Number</th>
                    <th>Holder</th>
                    <th>Issue Date</th>
                    <th>Expiration Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for reg in registrations %}
                <tr class="{% if reg.days_until_expiration and reg.days_until_expiration < 60 %}expiring-soon{% endif %}
                           {% if reg.days_until_expiration and reg.days_until_expiration < 0 %}expired{% endif %}">
                    <td>
                        <span class="reg-type-badge {{ reg.registration_type }}">
                            {{ reg.registration_type|upper }}
                        </span>
                    </td>
                    <td><strong>{{ reg.registration_number }}</strong></td>
                    <td>{{ reg.registrant_name or reg.business_name or 'Magnolia Health PLLC' }}</td>
                    <td>{{ reg.issue_date.strftime('%m/%d/%Y') if reg.issue_date else 'N/A' }}</td>
                    <td>
                        {{ reg.expiration_date.strftime('%m/%d/%Y') if reg.expiration_date else 'N/A' }}
                        {% if reg.days_until_expiration %}
                            {% if reg.days_until_expiration < 0 %}
                            <span class="days-badge expired">Expired</span>
                            {% elif reg.days_until_expiration < 30 %}
                            <span class="days-badge critical">{{ reg.days_until_expiration }} days</span>
                            {% elif reg.days_until_expiration < 60 %}
                            <span class="days-badge warning">{{ reg.days_until_expiration }} days</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if reg.is_active %}
                            {% if reg.days_until_expiration and reg.days_until_expiration < 0 %}
                            <span class="status-badge expired">Expired</span>
                            {% else %}
                            <span class="status-badge active">Active</span>
                            {% endif %}
                        {% else %}
                        <span class="status-badge inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('edit_registration', id=reg.id) }}" class="btn btn-secondary btn-sm">
                                Edit
                            </a>
                            {% if reg.document %}
                            <a href="{{ url_for('view_document', id=reg.document.id) }}" class="btn btn-secondary btn-sm" target="_blank">
                                View Doc
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <span class="empty-icon">üìã</span>
            <h3>No Registrations Found</h3>
            <p>Add your DEA and NC-DCU registrations to track expiration dates.</p>
            <a href="{{ url_for('add_registration') }}" class="btn btn-primary">Add Registration</a>
        </div>
        {% endif %}
    </div>

    <div class="info-cards">
        <div class="info-card">
            <h3>DEA Registration</h3>
            <p>DEA registration is required to handle controlled substances. Registration must be renewed:</p>
            <ul>
                <li><strong>Practitioners:</strong> Every 3 years</li>
                <li><strong>Pharmacies/Hospitals:</strong> Every 3 years</li>
            </ul>
            <p class="text-muted">Apply for renewal at least 45 days before expiration.</p>
        </div>

        <div class="info-card">
            <h3>NC-DCU Registration</h3>
            <p>North Carolina Diversion Control Unit registration requirements:</p>
            <ul>
                <li>Annual renewal required</li>
                <li>Must display registration certificate</li>
                <li>Subject to inspection at any time</li>
            </ul>
            <p class="text-muted">NC-DCU: (919) 733-1765</p>
        </div>
    </div>
</div>

<style>
.registrations-container {
    max-width: 1200px;
}

.registrations-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.expiring-soon {
    background-color: #fff8e6 !important;
}

.expired {
    background-color: #fff5f5 !important;
}

.reg-type-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
}

.reg-type-badge.dea {
    background: #1e4d6b;
    color: white;
}

.reg-type-badge.nc-dcu, .reg-type-badge.nc_dcu {
    background: #28a745;
    color: white;
}

.reg-type-badge.state {
    background: #6c757d;
    color: white;
}

.days-badge {
    display: inline-block;
    padding: 0.15rem 0.35rem;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 0.5rem;
}

.days-badge.warning {
    background: #fff3cd;
    color: #856404;
}

.days-badge.critical {
    background: #f8d7da;
    color: #721c24;
}

.days-badge.expired {
    background: #dc3545;
    color: white;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-badge.active {
    background: #d4edda;
    color: #155724;
}

.status-badge.inactive {
    background: #e2e3e5;
    color: #383d41;
}

.status-badge.expired {
    background: #f8d7da;
    color: #721c24;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.35rem 0.75rem;
    font-size: 0.85rem;
}

.info-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

@media (max-width: 800px) {
    .info-cards {
        grid-template-columns: 1fr;
    }
}

.info-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 1.5rem;
}

.info-card h3 {
    margin: 0 0 0.75rem 0;
    font-size: 1rem;
    color: #1e4d6b;
}

.info-card p {
    font-size: 0.9rem;
    color: #495057;
    margin-bottom: 0.5rem;
}

.info-card ul {
    margin: 0.5rem 0;
    padding-left: 1.25rem;
    font-size: 0.9rem;
}

.info-card li {
    margin-bottom: 0.25rem;
}

.empty-state {
    padding: 3rem;
    text-align: center;
}

.empty-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
}

.empty-state h3 {
    margin: 0 0 0.5rem 0;
}

.empty-state p {
    color: #6c757d;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

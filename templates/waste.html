{% extends "base.html" %}

{% block title %}Record Waste{% endblock %}
{% block page_title %}Record Medication Waste{% endblock %}

{% block content %}
<div class="form-container">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Record Controlled Substance Waste
            </h3>
        </div>
        <div class="card-body">
            <div class="alert alert-warning mb-3">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div>
                    <strong>Witness Required:</strong> DEA regulations require a witness for all controlled substance wasting. 
                    The witness must be a different person than the one performing the waste.
                </div>
            </div>
            
            <form method="POST" class="needs-validation">
                <!-- Medication Selection -->
                <div class="form-section">
                    <h4 class="form-section-title">Select Medication</h4>
                    
                    <div class="form-group">
                        <label for="inventory_id" class="form-label required">Inventory Item</label>
                        <select name="inventory_id" id="inventory_id" class="form-control" required>
                            <option value="">Select medication to waste...</option>
                            {% for item in inventory_items %}
                            <option value="{{ item.id }}" 
                                    data-schedule="{{ item.medication.schedule }}"
                                    data-available="{{ item.current_quantity }}"
                                    data-unit="{{ item.unit_count or 'units' }}">
                                [{{ item.medication.schedule }}] {{ item.medication.name }}
                                {% if item.medication.strength %}({{ item.medication.strength }}){% endif %}
                                - Lot: {{ item.lot_number or 'N/A' }}
                                - Qty: {{ item.current_quantity }} {{ item.unit_count or 'units' }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="inventoryInfo" class="info-panel" style="display:none;">
                        <div class="info-row">
                            <span class="info-label">Available:</span>
                            <span id="availableQty" class="font-mono font-bold"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Waste Details -->
                <div class="form-section">
                    <h4 class="form-section-title">Waste Details</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity" class="form-label required">Quantity to Waste</label>
                            <input type="number" name="quantity" id="quantity" class="form-control" required
                                   min="0.01" step="0.01" placeholder="Enter quantity">
                            <small class="form-text" id="quantityHelp"></small>
                        </div>
                        
                        <div class="form-group" style="flex: 2;">
                            <label for="reason" class="form-label required">Reason for Waste</label>
                            <select name="reason" id="reason" class="form-control" required>
                                <option value="">Select reason...</option>
                                <option value="partial_dose">Partial dose - remainder wasted</option>
                                <option value="patient_refused">Patient refused medication</option>
                                <option value="patient_discharged">Patient discharged before administration</option>
                                <option value="contaminated">Contaminated/compromised</option>
                                <option value="expired">Expired medication</option>
                                <option value="damaged">Damaged container/vial</option>
                                <option value="order_discontinued">Order discontinued</option>
                                <option value="other">Other (specify in notes)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Witness Selection -->
                <div class="form-section">
                    <h4 class="form-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        Witness Verification
                    </h4>
                    
                    <div class="alert alert-info mb-2">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <div>
                            <strong>Witness Authentication Required:</strong> The witness must enter their credentials to verify 
                            they are physically present and have observed the waste procedure.
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="witness_username" class="form-label required">Witness Username</label>
                            <input type="text" name="witness_username" id="witness_username" class="form-control" 
                                   required autocomplete="off" placeholder="Witness enters their username">
                        </div>
                        <div class="form-group">
                            <label for="witness_password" class="form-label required">Witness Password</label>
                            <input type="password" name="witness_password" id="witness_password" class="form-control" 
                                   required autocomplete="off" placeholder="Witness enters their password">
                        </div>
                    </div>
                    
                    <small class="form-text text-muted">
                        The witness must be physically present to observe the waste procedure and authenticate with their own credentials.
                        The witness cannot be the same person performing the waste.
                    </small>
                </div>
                
                <!-- Notes -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="notes" class="form-label">Additional Notes</label>
                        <textarea name="notes" id="notes" class="form-control" rows="3"
                                  placeholder="Any additional details about the waste (required if 'Other' reason selected)"></textarea>
                    </div>
                </div>
                
                <!-- Submit -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-warning btn-lg">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Record Waste
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
const inventorySelect = document.getElementById('inventory_id');
const quantityInput = document.getElementById('quantity');
const inventoryInfo = document.getElementById('inventoryInfo');
const availableQty = document.getElementById('availableQty');
const quantityHelp = document.getElementById('quantityHelp');

inventorySelect.addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    if (this.value) {
        const available = selected.dataset.available;
        const unit = selected.dataset.unit;
        availableQty.textContent = available + ' ' + unit;
        quantityHelp.textContent = 'Maximum: ' + available + ' ' + unit;
        quantityInput.max = available;
        inventoryInfo.style.display = 'block';
    } else {
        inventoryInfo.style.display = 'none';
        quantityHelp.textContent = '';
        quantityInput.max = '';
    }
});

// Require notes if "other" reason selected
const reasonSelect = document.getElementById('reason');
const notesInput = document.getElementById('notes');

reasonSelect.addEventListener('change', function() {
    if (this.value === 'other') {
        notesInput.required = true;
        notesInput.placeholder = 'Please specify the reason for waste (required)';
    } else {
        notesInput.required = false;
        notesInput.placeholder = 'Any additional details about the waste';
    }
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Start Physical Inventory{% endblock %}
{% block page_title %}Start Physical Inventory{% endblock %}

{% block header_actions %}
<a href="{{ url_for('physical_inventory_list') }}" class="btn btn-secondary btn-sm">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/>
    </svg>
    Cancel
</a>
{% endblock %}

{% block content %}
<div class="inventory-start-page">
    <form method="POST">
        <div class="form-section">
            <h4 class="form-section-title" style="text-align: center; margin-bottom: 1.5rem;">Select Count Type</h4>
            
            <div class="inventory-type-grid">
                <label class="inventory-type-card">
                    <input type="radio" name="inventory_type" value="daily" checked>
                    <div class="card-content">
                        <div class="card-icon daily">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                                <path d="M9 16l2 2 4-4"/>
                            </svg>
                        </div>
                        <h5>Daily Count</h5>
                        <p class="type-subtitle">All controlled substances</p>
                        <ul class="type-includes">
                            <li class="included">Clinic inventory (all schedules)</li>
                            <li class="included">Patient-owned medications</li>
                        </ul>
                    </div>
                </label>
                
                <label class="inventory-type-card">
                    <input type="radio" name="inventory_type" value="full">
                    <div class="card-content">
                        <div class="card-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                <line x1="12" y1="22.08" x2="12" y2="12"/>
                            </svg>
                        </div>
                        <h5>Full Inventory</h5>
                        <p class="type-subtitle">Clinic stock only</p>
                        <ul class="type-includes">
                            <li class="included">Clinic inventory (all schedules)</li>
                            <li class="excluded">Patient medications excluded</li>
                        </ul>
                    </div>
                </label>
                
                <label class="inventory-type-card">
                    <input type="radio" name="inventory_type" value="schedule2">
                    <div class="card-content">
                        <div class="card-icon schedule2">
                            <span class="schedule-icon">II</span>
                        </div>
                        <h5>Schedule II Only</h5>
                        <p class="type-subtitle">High-risk substances</p>
                        <ul class="type-includes">
                            <li class="included">Schedule II clinic inventory</li>
                            <li class="excluded">Schedule III-V excluded</li>
                        </ul>
                    </div>
                </label>
                
                <label class="inventory-type-card">
                    <input type="radio" name="inventory_type" value="spot_check" onchange="toggleSpotCheckItems()">
                    <div class="card-content">
                        <div class="card-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                                <circle cx="11" cy="11" r="8"/>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                        </div>
                        <h5>Spot Check</h5>
                        <p class="type-subtitle">Targeted verification</p>
                        <ul class="type-includes">
                            <li class="neutral">Select specific items</li>
                            <li class="neutral">Manual selection</li>
                        </ul>
                    </div>
                </label>
            </div>
            
            <!-- Spot Check Item Selection -->
            <div id="spot-check-items" class="spot-check-selection" style="display: none;">
                <h5 style="margin-bottom: 0.5rem;">Select Items to Count</h5>
                <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 1rem;">Check the items you want to include in this spot check.</p>
                
                <div class="spot-check-list">
                    {% for item in available_items %}
                    <label class="spot-check-item">
                        <input type="checkbox" name="spot_items" value="{{ item.id }}">
                        <div class="spot-item-info">
                            <span class="schedule-badge schedule-{{ item.medication.schedule|lower }}">{{ item.medication.schedule }}</span>
                            <strong>{{ item.medication.name }}</strong>
                            {% if item.medication.strength %}<span class="text-muted">{{ item.medication.strength }}</span>{% endif %}
                            <span class="text-muted">| Lot: {{ item.lot_number or 'N/A' }}</span>
                            <span class="text-muted">| Qty: {{ '%g'|format(item.current_quantity) }} {{ item.unit_count or item.medication.unit or 'units' }}</span>
                        </div>
                    </label>
                    {% else %}
                    <p class="text-muted" style="padding: 1rem;">No inventory items available.</p>
                    {% endfor %}
                </div>
                
                <div class="spot-check-actions">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllSpotItems()">Select All</button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllSpotItems()">Deselect All</button>
                </div>
            </div>
        </div>
        
        <div class="form-section notes-section">
            <div class="form-group">
                <label for="notes" class="form-label">Notes</label>
                <textarea name="notes" id="notes" class="form-control" rows="2"
                          placeholder="Optional notes about this inventory count"></textarea>
            </div>
        </div>
        
        <div class="form-actions" style="justify-content: center;">
            <button type="submit" class="btn btn-primary btn-lg">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                Start Count
            </button>
            <a href="{{ url_for('physical_inventory_list') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<style>
.inventory-start-page {
    max-width: 700px;
    margin: 0 auto;
}

.inventory-type-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

@media (max-width: 550px) {
    .inventory-type-grid {
        grid-template-columns: 1fr;
    }
}

.inventory-type-card {
    cursor: pointer;
    display: block;
}

.inventory-type-card input {
    display: none;
}

.inventory-type-card .card-content {
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    text-align: center;
    transition: all 0.2s ease;
    background: white;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.inventory-type-card:hover .card-content {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.inventory-type-card input:checked + .card-content {
    border-color: var(--primary);
    background: linear-gradient(to bottom, rgba(30, 77, 107, 0.04), rgba(30, 77, 107, 0.08));
    box-shadow: 0 2px 12px rgba(30, 77, 107, 0.15);
}

.inventory-type-card .card-icon {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.75rem;
    color: var(--primary);
    transition: all 0.2s ease;
}

.inventory-type-card input:checked + .card-content .card-icon {
    background: var(--primary);
    color: white;
}

.inventory-type-card .card-icon.daily {
    background: rgba(45, 122, 79, 0.1);
    color: var(--success);
}

.inventory-type-card input:checked + .card-content .card-icon.daily {
    background: var(--success);
    color: white;
}

.inventory-type-card .card-icon.schedule2 {
    background: rgba(181, 137, 0, 0.1);
    color: var(--warning);
}

.inventory-type-card input:checked + .card-content .card-icon.schedule2 {
    background: var(--warning);
    color: white;
}

.inventory-type-card .schedule-icon {
    font-size: 1.25rem;
    font-weight: 700;
}

.inventory-type-card h5 {
    margin: 0 0 0.25rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.inventory-type-card .type-subtitle {
    margin: 0 0 0.75rem;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.type-includes {
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
    text-align: left;
    font-size: 0.8rem;
}

.type-includes li {
    padding: 0.2rem 0;
    padding-left: 1.25rem;
    position: relative;
}

.type-includes li::before {
    position: absolute;
    left: 0;
    font-weight: 600;
}

.type-includes li.included {
    color: var(--success);
}

.type-includes li.included::before {
    content: "✓";
}

.type-includes li.excluded {
    color: var(--gray-400);
}

.type-includes li.excluded::before {
    content: "✗";
}

.type-includes li.neutral {
    color: var(--text-muted);
}

.type-includes li.neutral::before {
    content: "○";
}

.notes-section {
    max-width: 700px;
    margin: 1.5rem auto 0;
}

/* Spot Check Selection Styles */
.spot-check-selection {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
}

.spot-check-list {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-sm);
    background: white;
}

.spot-check-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--gray-100);
    cursor: pointer;
    transition: background 0.15s;
}

.spot-check-item:last-child {
    border-bottom: none;
}

.spot-check-item:hover {
    background: var(--gray-50);
}

.spot-check-item input[type="checkbox"] {
    margin-right: 0.75rem;
    width: 18px;
    height: 18px;
}

.spot-item-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    font-size: 0.85rem;
}

.spot-check-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}
</style>

<script>
function toggleSpotCheckItems() {
    const spotCheckDiv = document.getElementById('spot-check-items');
    const selectedType = document.querySelector('input[name="inventory_type"]:checked');
    
    if (selectedType && selectedType.value === 'spot_check') {
        spotCheckDiv.style.display = 'block';
    } else {
        spotCheckDiv.style.display = 'none';
    }
}

function selectAllSpotItems() {
    document.querySelectorAll('input[name="spot_items"]').forEach(cb => cb.checked = true);
}

function deselectAllSpotItems() {
    document.querySelectorAll('input[name="spot_items"]').forEach(cb => cb.checked = false);
}

// Add change listeners to all inventory type radios
document.querySelectorAll('input[name="inventory_type"]').forEach(radio => {
    radio.addEventListener('change', toggleSpotCheckItems);
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', toggleSpotCheckItems);
</script>
{% endblock %}
